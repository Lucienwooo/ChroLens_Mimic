# ChroLens_Mimic 更新系統說明

## 📦 打包後的目錄結構

```
dist\ChroLens_Mimic\
├── ChroLens_Mimic.exe      # 主程式
├── version2.6.3.txt         # 版本資訊
├── _internal\               # 程式核心（Python 運行時環境）
├── scripts\                 # 使用者腳本目錄
│   └── README.txt          # 說明文件
├── user_config.json         # 使用者設定
├── last_script.txt          # 最後腳本記錄
├── hotkeys.json            # 快捷鍵設定
├── updater.bat             # 更新腳本（備用）
└── backup\                  # 備份目錄
    └── 2.6.2\              # 舊版本備份
        ├── ChroLens_Mimic.exe
        ├── version2.6.2.txt
        └── 下載點.txt      # GitHub 下載連結
```

## 🔄 更新流程

### 使用者操作流程：

1. **開啟主程式** → ChroLens_Mimic.exe
2. **檢查版本** → 點擊「檢查更新」按鈕
3. **發現新版本** → 顯示更新內容和版本資訊
4. **點擊更新** → 開始自動下載
5. **自動安裝** → 備份舊版 → 安裝新版 → 保留用戶數據
6. **點擊重啟** → 自動重啟新版程式

### 技術實現：

```python
# 1. 檢查更新（連接 GitHub API）
UpdateSystem.check_for_updates()
  └─> 從 GitHub 獲取最新版本資訊
  └─> 比較版本號
  └─> 返回更新資訊

# 2. 下載更新（ZIP 檔案）
UpdateSystem.download_update(url, filename)
  └─> 下載到臨時目錄
  └─> 顯示進度條

# 3. 應用更新（關鍵步驟）
UpdateSystem.apply_update(zip_path, new_version)
  ├─> 備份當前版本
  │   ├─> 複製 exe 到 backup\{version}\
  │   └─> 創建下載連結文件
  ├─> 備份用戶數據
  │   ├─> scripts/
  │   ├─> user_config.json
  │   ├─> hotkeys.json
  │   └─> last_script.txt
  ├─> 解壓新版本
  │   └─> 解壓到臨時目錄
  ├─> 安裝新版本
  │   ├─> 刪除舊的 exe 和 _internal
  │   ├─> 複製新的 exe 和 _internal
  │   └─> 複製新的版本文件
  └─> 恢復用戶數據
      └─> 從備份還原用戶文件

# 4. 重啟應用
UpdateSystem.restart_application()
  └─> 啟動新的 exe
  └─> 關閉當前程式
```

## 🛡️ 用戶數據保護

### 自動保留的文件：
- ✅ `scripts/` - 所有腳本文件
- ✅ `user_config.json` - 程式設定
- ✅ `hotkeys.json` - 快捷鍵配置
- ✅ `last_script.txt` - 最後使用的腳本

### 自動更新的文件：
- 🔄 `ChroLens_Mimic.exe` - 主程式
- 🔄 `_internal/` - Python 運行環境
- 🔄 `version*.txt` - 版本資訊

### 自動備份：
- 💾 舊版本 exe 備份到 `backup\{version}\`
- 💾 包含 GitHub 下載連結

## ⚙️ 打包說明

### 使用 build_simple.py：

```bash
cd main
python build_simple.py
```

### 或使用批次腳本：

```bash
快速打包.bat
```

### 打包流程：

1. **清理舊檔案** - 刪除 dist/ 和 build/
2. **打包主程式** - 使用 PyInstaller
3. **複製必要文件** - scripts/, backup/, 配置檔
4. **創建版本文件** - version{版本號}.txt
5. **創建 ZIP 包** - 用於 GitHub Release

## 📤 發布更新

### 在 GitHub 上發布：

1. 執行打包腳本生成 `ChroLens_Mimic.zip`
2. 在 GitHub 創建新的 Release
3. 上傳 ZIP 檔案
4. 使用版本標籤（例如：v2.6.4）
5. 填寫更新說明

### 用戶會自動：
- 檢測到新版本
- 下載 ZIP 更新包
- 解壓並安裝
- 保留所有用戶數據
- 自動重啟程式

## 🔧 故障排除

### 如果更新失敗：

1. **手動備份數據**
   - 複製 `scripts/` 目錄
   - 複製 `user_config.json`

2. **下載完整版本**
   - 從 GitHub Releases 下載 ZIP
   - 解壓到新目錄

3. **恢復數據**
   - 將備份的檔案複製回去

### 如果程式無法啟動（Python interpreter error）：

1. **檢查 _internal 目錄**
   - 確保完整存在
   - 不要手動修改其中的檔案

2. **重新安裝**
   - 刪除整個程式目錄
   - 重新解壓 ZIP 檔案

3. **從備份還原**
   - 使用 `backup\{version}\` 中的舊版本

## 📝 開發注意事項

### 修改版本號：
在 `ChroLens_Mimic.py` 中修改：
```python
VERSION = "2.6.4"  # 更新這裡
```

### 添加更新日誌：
在程式頂部的註釋中添加：
```python
# [2.6.4] - 2025/11/06
#   - 新功能說明
#   - 錯誤修正
```

### 測試更新系統：
1. 本地打包測試
2. 手動測試解壓和安裝
3. 確認用戶數據保留
4. 確認程式可正常啟動

## 🎯 設計理念

參考以下軟體的更新方式：
- **VSCode** - 自動下載、備份、安裝、重啟
- **Discord** - 無感更新、保留設定
- **Electron Apps** - ZIP 包更新、替換檔案
- **ExplorerPatcher** - 安裝器模式

### 核心特點：
✅ 完全自動化 - 一鍵更新
✅ 數據安全 - 自動備份和恢復
✅ 可回溯 - 保留舊版本
✅ 用戶友好 - 清晰的進度顯示
✅ 錯誤處理 - 失敗時可回滾

---

**ChroLens Studio - 2025**
