# ChroLens_Mimic é‡æ§‹å¯¦æ–½è¨ˆç•«

## ğŸ“‹ é‡æ§‹ç¸½è¦½

### å·²å®Œæˆé …ç›® âœ…

#### 1. **ConfigManager - é…ç½®ç®¡ç†å™¨** (`config_manager.py`)
- âœ… å–®ä¾‹æ¨¡å¼å¯¦ç¾
- âœ… åŸ·è¡Œç·’å®‰å…¨çš„è®€å¯«æ“ä½œ
- âœ… é…ç½®é·ç§»æ©Ÿåˆ¶ï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
- âœ… fsync å®‰å…¨å¯«å…¥ï¼ˆé˜²æ­¢è—å±/æ–·é›»ææ¯€ï¼‰
- âœ… æä¾›å‘ä¸‹ç›¸å®¹å‡½å¼ `load_user_config()` å’Œ `save_user_config()`

**ä½¿ç”¨æ–¹å¼ï¼š**
```python
# æ–°ä»£ç¢¼ï¼ˆæ¨è–¦ï¼‰
from config_manager import ConfigManager
config = ConfigManager.get_instance()
value = config.get("key", default)
config.set("key", value)
config.save()

# èˆŠä»£ç¢¼ï¼ˆä»å¯ä½¿ç”¨ï¼‰
from config_manager import load_user_config, save_user_config
config = load_user_config()
save_user_config(config)
```

#### 2. **LoggerHandler - æ—¥èªŒç³»çµ±** (`logger_handler.py`)
- âœ… æ¨™æº–åŒ– logging æ¨¡çµ„æ•´åˆ
- âœ… TkTextHandlerï¼ˆè¼¸å‡ºåˆ° Text Widgetï¼‰
- âœ… åŸ·è¡Œç·’å®‰å…¨çš„ UI æ›´æ–°
- âœ… é¡è‰²æ¨™è¨˜ï¼ˆINFO/WARNING/ERRORï¼‰
- âœ… è‡ªå‹•è¡Œæ•¸é™åˆ¶ï¼ˆé˜²æ­¢è¨˜æ†¶é«”æº¢å‡ºï¼‰
- âœ… åŒæ™‚è¼¸å‡ºåˆ°æª”æ¡ˆï¼ˆdebug.logï¼‰

**ä½¿ç”¨æ–¹å¼ï¼š**
```python
from logger_handler import LoggerManager

# åœ¨ RecorderApp.__init__ ä¸­åˆå§‹åŒ–
logger_mgr = LoggerManager.get_instance()
logger_mgr.setup_text_handler(self.log_text)
logger_mgr.setup_file_handler("debug.log")

# åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨
logger_mgr.info("è¨Šæ¯")
logger_mgr.warning("è­¦å‘Š")
logger_mgr.error("éŒ¯èª¤", exc_info=True)
```

#### 3. **BezierMouse - è²èŒ²æ›²ç·šæ»‘é¼ ** (`bezier_mouse.py`)
- âœ… äºŒæ¬¡/ä¸‰æ¬¡è²èŒ²æ›²ç·šè»Œè·¡
- âœ… éš¨æ©Ÿæ§åˆ¶é»ï¼ˆæ¯æ¬¡ç§»å‹•è·¯å¾‘ä¸åŒï¼‰
- âœ… Ease-in/Ease-out é€Ÿåº¦è®ŠåŒ–
- âœ… å¯èª¿åƒæ•¸ï¼ˆæŒçºŒæ™‚é–“ã€éš¨æ©Ÿåº¦ã€é€Ÿåº¦æ›²ç·šï¼‰

**ä½¿ç”¨æ–¹å¼ï¼š**
```python
from bezier_mouse import BezierMouseMover

mover = BezierMouseMover()
mover.move_to(
    target_x=500, 
    target_y=300,
    duration=0.5,           # 0.5ç§’ç§»å‹•
    curve_type="cubic",     # ä¸‰æ¬¡è²èŒ²æ›²ç·š
    randomness=0.3,         # è¼•å¾®éš¨æ©Ÿ
    easing="ease_in_out"    # Så‹é€Ÿåº¦æ›²ç·š
)
```

#### 4. **OCRTrigger - OCR æ–‡å­—è§¸ç™¼** (`ocr_trigger.py`)
- âœ… é ç•™ä»‹é¢è¨­è¨ˆ
- âœ… æ”¯æ´ pytesseract å’Œ Windows Runtime OCR
- âœ… ç­‰å¾…æ–‡å­—å‡ºç¾åŠŸèƒ½
- âœ… å¤šç¨®åŒ¹é…æ¨¡å¼ï¼ˆcontains/exact/regexï¼‰

**ä½¿ç”¨æ–¹å¼ï¼š**
```python
from ocr_trigger import OCRTrigger

ocr = OCRTrigger(ocr_engine="auto")
if ocr.is_available():
    # ç­‰å¾…è¢å¹•å‡ºç¾ã€Œç¢ºèªã€æ–‡å­—
    found = ocr.wait_for_text("ç¢ºèª", timeout=10)
    if found:
        print("æ‰¾åˆ°æ–‡å­—ï¼Œç¹¼çºŒåŸ·è¡Œ")
```

#### 5. **script_io.py - å®‰å…¨å„²å­˜**
- âœ… åŠ å…¥ `flush()` å’Œ `fsync()` ç¢ºä¿è³‡æ–™å¯«å…¥ç£ç¢Ÿ
- âœ… é˜²æ­¢è—å±/æ–·é›»æ™‚æª”æ¡ˆç‚ºç©ºæˆ–ææ¯€
- âœ… æ‰€æœ‰å¯«å…¥å‡½å¼éƒ½å·²å¼·åŒ–

---

## ğŸš§ å¾…å®Œæˆé …ç›®

### éšæ®µäºŒï¼šä¿®æ”¹ recorder.py

#### ç›®æ¨™ï¼š
1. **æ•´åˆ BezierMouseMover**
   - åœ¨ `CoreRecorder` ä¸­åŠ å…¥æ“¬çœŸæ»‘é¼ ç§»å‹•é¸é …
   - ä¿®æ”¹ `move_to` å’Œå›æ”¾é‚è¼¯

2. **æ•´åˆ LoggerHandler**
   - å°‡ `self.logger` æ”¹ç‚ºä½¿ç”¨ `LoggerManager`
   - ç§»é™¤ç›´æ¥çš„ print æˆ–å›èª¿å‡½å¼

3. **åŠ å…¥ OCR è§¸ç™¼æ”¯æ´**
   - æ–°å¢ `wait_for_text` äº‹ä»¶é¡å‹
   - åœ¨å›æ”¾æ™‚æ”¯æ´ OCR æ¢ä»¶ç­‰å¾…

#### ä¿®æ”¹ç¯„ä¾‹ï¼š
```python
# recorder.py

from logger_handler import LoggerManager
from bezier_mouse import BezierMouseMover

class CoreRecorder:
    def __init__(self):
        # ä½¿ç”¨æ¨™æº–åŒ–æ—¥èªŒ
        self.logger = LoggerManager.get_instance()
        
        # è²èŒ²æ›²ç·šç§»å‹•å™¨
        self.bezier_mover = BezierMouseMover()
        self.use_bezier = False  # æ˜¯å¦å•Ÿç”¨æ“¬çœŸç§»å‹•
    
    def set_bezier_enabled(self, enabled: bool):
        """å•Ÿç”¨/åœç”¨è²èŒ²æ›²ç·šç§»å‹•"""
        self.use_bezier = enabled
        if enabled:
            self.logger.info("âœ… å·²å•Ÿç”¨æ“¬çœŸæ»‘é¼ ç§»å‹•ï¼ˆè²èŒ²æ›²ç·šï¼‰")
        else:
            self.logger.info("âš ï¸ å·²åœç”¨æ“¬çœŸç§»å‹•ï¼ˆç›´ç·šç§»å‹•ï¼‰")
    
    def _move_mouse(self, x, y):
        """ç§»å‹•æ»‘é¼ ï¼ˆè‡ªå‹•é¸æ“‡ç§»å‹•æ–¹å¼ï¼‰"""
        if self.use_bezier:
            self.bezier_mover.move_to(x, y, duration=0.3, curve_type="cubic")
        else:
            # åŸæœ¬çš„ç›´ç·šç§»å‹•
            ctypes.windll.user32.SetCursorPos(int(x), int(y))
```

---

### éšæ®µä¸‰ï¼šé‡æ§‹ ChroLens_Mimic.pyï¼ˆæ ¸å¿ƒå·¥ä½œï¼‰

#### ç›®æ¨™ï¼šMVC æ¶æ§‹åˆ†é›¢

**å•é¡Œï¼š** ç›®å‰ `RecorderApp` é¡åˆ¥æœ‰ 4182 è¡Œï¼ŒåŒ…å«ï¼š
- UI ç¹ªè£½èˆ‡äº‹ä»¶ç¶å®š
- éŒ„è£½/å›æ”¾é‚è¼¯
- é…ç½®ç®¡ç†
- æ—¥èªŒè¼¸å‡º
- ç†±éµç®¡ç†

**è§£æ±ºæ–¹æ¡ˆï¼š** æ‹†åˆ†ç‚º MVC æ¶æ§‹

#### 1. **View (UI å±¤)** - `RecorderApp`
ä¿ç•™å…§å®¹ï¼š
- Tkinter ä»‹é¢ç¹ªè£½ï¼ˆ`__init__` ä¸­çš„æ‰€æœ‰ UI ä»£ç¢¼ï¼‰
- æŒ‰éˆ•äº‹ä»¶ç¶å®š
- é€²åº¦æ›´æ–°ï¼ˆé€éå›èª¿å‡½å¼ï¼‰

ç§»é™¤å…§å®¹ï¼š
- éŒ„è£½/å›æ”¾é‚è¼¯ â†’ ç§»åˆ° `RecorderController`
- é…ç½®ç®¡ç† â†’ ä½¿ç”¨ `ConfigManager`
- æ—¥èªŒè¼¸å‡º â†’ ä½¿ç”¨ `LoggerManager`

#### 2. **Controller (é‚è¼¯å±¤)** - æ–°å»º `RecorderController`
```python
# recorder_controller.py

from recorder import CoreRecorder
from logger_handler import LoggerManager
from config_manager import ConfigManager

class RecorderController:
    """éŒ„è£½æ§åˆ¶å™¨ï¼ˆMVC çš„ Controllerï¼‰
    
    è·è²¬ï¼š
    - å”èª¿ UI å’Œ CoreRecorder
    - ç®¡ç†éŒ„è£½/å›æ”¾ç‹€æ…‹
    - è™•ç†äº‹ä»¶å›èª¿
    """
    
    def __init__(self, view_callback=None):
        self.recorder = CoreRecorder()
        self.logger = LoggerManager.get_instance()
        self.config = ConfigManager.get_instance()
        self.view_callback = view_callback  # å›èª¿ UI æ›´æ–°
    
    def start_recording(self):
        """é–‹å§‹éŒ„è£½"""
        self.logger.info("é–‹å§‹éŒ„è£½...")
        self.recorder.start_record()
        if self.view_callback:
            self.view_callback("recording_started")
    
    def stop_recording(self):
        """åœæ­¢éŒ„è£½"""
        self.logger.info("åœæ­¢éŒ„è£½")
        self.recorder.stop_record()
        if self.view_callback:
            self.view_callback("recording_stopped")
    
    # ... å…¶ä»–é‚è¼¯æ–¹æ³•
```

#### 3. **Model (è³‡æ–™å±¤)** - `CoreRecorder`
å·²å­˜åœ¨ï¼Œä¿æŒä¸è®Šï¼Œè² è²¬åº•å±¤æ“ä½œã€‚

---

### éšæ®µå››ï¼šä¿®å¾© keyboard.unhook_all å•é¡Œ

#### å•é¡Œï¼š
ç›®å‰ä½¿ç”¨ `keyboard.unhook_all()` æœƒå°è‡´ä½¿ç”¨è€…çš„å…¶ä»–å…¨åŸŸç†±éµå¤±æ•ˆã€‚

#### è§£æ±ºæ–¹æ¡ˆï¼š
```python
class RecorderApp:
    def __init__(self):
        # âœ… å„²å­˜æ‰€æœ‰è¨»å†Šçš„ç†±éµ handle
        self._hotkey_handles = []
    
    def _register_hotkeys(self):
        """è¨»å†Šç†±éµä¸¦å„²å­˜ handle"""
        # æ¸…ç†èˆŠçš„ç†±éµ
        self._unregister_hotkeys()
        
        # è¨»å†Šæ–°ç†±éµ
        handle1 = keyboard.add_hotkey(self.hotkey_map["start"], self.start_record)
        self._hotkey_handles.append(handle1)
        
        handle2 = keyboard.add_hotkey(self.hotkey_map["pause"], self.toggle_pause)
        self._hotkey_handles.append(handle2)
        
        # ... å…¶ä»–ç†±éµ
    
    def _unregister_hotkeys(self):
        """åƒ…ç§»é™¤æœ¬ç¨‹å¼è¨»å†Šçš„ç†±éµ"""
        for handle in self._hotkey_handles:
            try:
                keyboard.remove_hotkey(handle)
            except:
                pass
        self._hotkey_handles.clear()
    
    def force_quit(self):
        """å¼·åˆ¶é—œé–‰ï¼ˆä¸å½±éŸ¿å…¶ä»–ç¨‹å¼çš„ç†±éµï¼‰"""
        self._unregister_hotkeys()  # âœ… åªç§»é™¤æœ¬ç¨‹å¼çš„ç†±éµ
        # keyboard.unhook_all()     # âŒ ä¸å†ä½¿ç”¨
        self.destroy()
```

---

## ğŸ“ å¯¦æ–½æ­¥é©Ÿå»ºè­°

### ç¬¬ä¸€æ­¥ï¼šæ¸¬è©¦æ–°æ¨¡çµ„ï¼ˆå·²å®Œæˆï¼‰
```bash
# æ¸¬è©¦é…ç½®ç®¡ç†å™¨
python config_manager.py

# æ¸¬è©¦æ—¥èªŒç³»çµ±
python logger_handler.py

# æ¸¬è©¦è²èŒ²æ›²ç·š
python bezier_mouse.py

# æ¸¬è©¦ OCRï¼ˆéœ€å®‰è£ pytesseractï¼‰
python ocr_trigger.py
```

### ç¬¬äºŒæ­¥ï¼šæ•´åˆåˆ° recorder.py
1. ä¿®æ”¹ `CoreRecorder.__init__`ï¼ŒåŠ å…¥ `BezierMouseMover` å’Œ `LoggerManager`
2. æ–°å¢ `set_bezier_enabled()` æ–¹æ³•
3. ä¿®æ”¹ `_move_mouse()` é‚è¼¯
4. æ›¿æ›æ‰€æœ‰ `self.logger()` ç‚º `self.logger.info()`

### ç¬¬ä¸‰æ­¥ï¼šä¿®æ”¹ ChroLens_Mimic.py
1. åŒ¯å…¥æ–°æ¨¡çµ„ï¼š
   ```python
   from config_manager import ConfigManager
   from logger_handler import LoggerManager
   ```

2. ä¿®æ”¹ `RecorderApp.__init__`ï¼š
   ```python
   # ä½¿ç”¨æ–°é…ç½®ç®¡ç†å™¨
   self.config = ConfigManager.get_instance()
   skin = self.config.get("skin", "darkly")
   
   # ä½¿ç”¨æ–°æ—¥èªŒç³»çµ±
   self.logger = LoggerManager.get_instance()
   self.logger.setup_text_handler(self.log_text)
   ```

3. æ›¿æ›æ‰€æœ‰é…ç½®è®€å¯«ï¼š
   ```python
   # èˆŠä»£ç¢¼
   self.user_config["key"] = value
   save_user_config(self.user_config)
   
   # æ–°ä»£ç¢¼
   self.config.set("key", value)
   self.config.save()
   ```

4. æ›¿æ›æ‰€æœ‰æ—¥èªŒè¼¸å‡ºï¼š
   ```python
   # èˆŠä»£ç¢¼
   self.log_text.insert(tk.END, "è¨Šæ¯\n")
   
   # æ–°ä»£ç¢¼
   self.logger.info("è¨Šæ¯")
   ```

5. ä¿®å¾©ç†±éµç®¡ç†ï¼š
   - åŠ å…¥ `self._hotkey_handles = []`
   - ä¿®æ”¹ `_register_hotkeys()` å„²å­˜ handle
   - ä¿®æ”¹ `force_quit()` ç§»é™¤ `keyboard.unhook_all()`

### ç¬¬å››æ­¥ï¼šå®Œæ•´æ¸¬è©¦
1. æ¸¬è©¦éŒ„è£½/å›æ”¾åŠŸèƒ½
2. æ¸¬è©¦ç†±éµè¨»å†Š/ç§»é™¤
3. æ¸¬è©¦é…ç½®å„²å­˜/è¼‰å…¥
4. æ¸¬è©¦æ—¥èªŒè¼¸å‡º
5. æ¸¬è©¦è²èŒ²æ›²ç·šç§»å‹•ï¼ˆéœ€åœ¨ UI åŠ å…¥åˆ‡æ›é¸é …ï¼‰

---

## âš ï¸ æ³¨æ„äº‹é …

### å‘ä¸‹ç›¸å®¹æ€§
- âœ… æ‰€æœ‰æ–°æ¨¡çµ„æä¾›å‘ä¸‹ç›¸å®¹å‡½å¼
- âœ… èˆŠçš„ `user_config.json` æ ¼å¼ä»å¯æ­£å¸¸è®€å–
- âœ… èˆŠçš„è…³æœ¬æª”æ¡ˆæ ¼å¼ä»å¯æ­£å¸¸è¼‰å…¥

### UI ä¸è®ŠåŸå‰‡
- âœ… ä¸ä¿®æ”¹ä»»ä½• UI ä½ˆå±€å’Œæ’ç‰ˆ
- âœ… åªä¿®æ”¹åº•å±¤é‚è¼¯
- âœ… ä½¿ç”¨è€…ä¸æœƒå¯Ÿè¦ºä»‹é¢è®ŠåŒ–

### æ¼¸é€²å¼é‡æ§‹
- å»ºè­°ä¸€æ¬¡ä¿®æ”¹ä¸€å€‹æ¨¡çµ„
- æ¯æ¬¡ä¿®æ”¹å¾Œç«‹å³æ¸¬è©¦
- ä¿ç•™ Git commit è¨˜éŒ„ï¼Œæ–¹ä¾¿å›æ»¾

---

## ğŸ“Š é‡æ§‹é€²åº¦

| é …ç›® | ç‹€æ…‹ | æª”æ¡ˆ |
|------|------|------|
| ConfigManager | âœ… å®Œæˆ | `config_manager.py` |
| LoggerHandler | âœ… å®Œæˆ | `logger_handler.py` |
| BezierMouse | âœ… å®Œæˆ | `bezier_mouse.py` |
| OCRTrigger | âœ… å®Œæˆ | `ocr_trigger.py` |
| script_io å®‰å…¨æ€§ | âœ… å®Œæˆ | `script_io.py` |
| recorder.py æ•´åˆ | â³ å¾…å®Œæˆ | `recorder.py` |
| ChroLens_Mimic é‡æ§‹ | â³ å¾…å®Œæˆ | `ChroLens_Mimic.py` |
| ç†±éµç®¡ç†ä¿®å¾© | â³ å¾…å®Œæˆ | `ChroLens_Mimic.py` |

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡Œå‹•

### ç«‹å³å¯åšï¼š
1. **æ¸¬è©¦æ–°æ¨¡çµ„** - åŸ·è¡Œå„æ¨¡çµ„çš„æ¸¬è©¦ä»£ç¢¼
2. **å‚™ä»½åŸå§‹æª”æ¡ˆ** - è¤‡è£½ `ChroLens_Mimic.py` ç‚º `ChroLens_Mimic.py.backup`
3. **é–‹å§‹æ•´åˆ** - å¾ç°¡å–®çš„éƒ¨åˆ†é–‹å§‹ï¼ˆé…ç½®ç®¡ç†ã€æ—¥èªŒç³»çµ±ï¼‰

### éœ€è¦æ±ºç­–ï¼š
1. æ˜¯å¦è¦å®Œå…¨é‡æ§‹ç‚º MVCï¼Ÿï¼ˆå»ºè­°ï¼šæ¼¸é€²å¼ï¼Œå…ˆæ•´åˆæ–°æ¨¡çµ„ï¼‰
2. æ˜¯å¦è¦åœ¨ UI åŠ å…¥ã€Œæ“¬çœŸç§»å‹•ã€åˆ‡æ›é¸é …ï¼Ÿ
3. æ˜¯å¦è¦å¯¦éš›å•Ÿç”¨ OCR åŠŸèƒ½ï¼Ÿï¼ˆéœ€å®‰è£ pytesseractï¼‰

---

**é‡æ§‹åŸå‰‡ï¼šMake it work, make it right, make it fast.**
å…ˆè®“æ–°æ¨¡çµ„æ­£å¸¸é‹ä½œï¼Œå†é€æ­¥æ›¿æ›èˆŠä»£ç¢¼ï¼Œæœ€å¾Œå„ªåŒ–æ•ˆèƒ½ã€‚
