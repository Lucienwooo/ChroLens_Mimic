# ChroLens_Mimic 開發文檔

## 快速開始

### 運行程式
```bash
python ChroLens_Mimic.py
```

### 打包程式
```bash
python build_simple.py
```

## 打包說明

### 打包工具
- **build_simple.py** - 簡化打包工具 (推薦使用)
  - 只打包主程式
  - 自動複製 updater.bat
  - 生成版本文件
  - 創建 ZIP 包

### 打包產出
- `dist/ChroLens_Mimic/ChroLens_Mimic.exe` - 主程式
- `dist/ChroLens_Mimic/updater.bat` - 更新器
- `dist/ChroLens_Mimic/version2.6.4.txt` - 版本文件
- `dist/ChroLens_Mimic/_internal/` - Python 運行時
- `dist/ChroLens_Mimic.zip` - 完整包

### 打包流程
1. 清理舊檔案 (build/, dist/)
2. 使用 PyInstaller 打包主程式
3. 複製 updater.bat 到輸出目錄
4. 創建版本文件
5. 打包成 ZIP

## 更新系統

### 架構設計
```
主程式 (ChroLens_Mimic.exe)
    ↓
UpdateManager (update_manager_v2.py)
    ↓ 檢測更新
GitHub Releases API
    ↓ 下載 ZIP
本地臨時目錄
    ↓ 啟動更新器
updater.bat (批次腳本)
    ↓ 解壓縮
PowerShell Expand-Archive
    ↓ 替換檔案
xcopy / copy 命令
    ↓ 重啟程式
start 命令
```

### 更新器說明 (updater.bat)

**功能**:
- 等待主程式關閉 (3 秒)
- 備份用戶數據 (scripts/, user_config.json, last_script.txt)
- 刪除舊檔案 (_internal/, .exe, version*.txt)
- 解壓縮 ZIP 到臨時目錄
- 複製新檔案到安裝目錄
- 還原用戶數據
- 刪除 ZIP 和臨時目錄
- 重啟程式

**優點**:
- 簡單可靠，使用原生 Windows 命令
- 易於調試和維護
- 不需要額外的 Python 運行時
- 避免了 Python updater.exe 的路徑檢測問題

### 更新流程

1. **檢測更新**
   - UpdateManager 調用 GitHub API
   - 比對本地版本與最新版本
   - 顯示更新提示

2. **下載更新**
   - 從 GitHub Releases 下載 ZIP
   - 顯示下載進度
   - 驗證檔案完整性

3. **應用更新**
   - 啟動 updater.bat
   - 關閉主程式 (sys.exit)
   - updater.bat 執行更新流程
   - 自動重啟程式

## 模組架構

### 核心模組
- **ChroLens_Mimic.py** - 主程式
- **recorder.py** - 錄製功能
- **script_parser.py** - 腳本解析器
- **update_manager_v2.py** - 更新管理器

### UI 模組
- **ui_components.py** - UI 元件
- **visual_script_editor.py** - 視覺化腳本編輯器
- **window_selector.py** - 視窗選擇器
- **mini.py** - 迷你模式

### 輔助模組
- **config_manager.py** - 配置管理
- **hotkey_manager.py** - 熱鍵管理
- **script_io.py** - 腳本 IO
- **script_manager.py** - 腳本管理
- **script_editor_methods.py** - 編輯器方法
- **lang.py** - 語言支援
- **about.py** - 關於對話框

### 打包模組
- **build_simple.py** - 簡化打包工具
- **updater.bat** - 更新器批次腳本

## 版本號規則

格式: `MAJOR.MINOR.PATCH`
- MAJOR: 重大架構變更
- MINOR: 新功能增加
- PATCH: Bug 修復和小改進

目前版本: **2.6.4**

## 發布流程

1. 更新 VERSION 常數 (ChroLens_Mimic.py)
2. 更新版本歷史註釋
3. 執行 `python build_simple.py`
4. 測試打包的程式
5. 上傳到 GitHub Releases:
   - ChroLens_Mimic.zip
   - version2.6.4.txt
6. 用戶端自動檢測並提示更新

## 開發建議

### 測試更新系統
1. 在本地運行主程式
2. 手動觸發更新檢測
3. 觀察 updater.bat 執行過程
4. 確認檔案正確替換
5. 確認用戶數據未丟失
6. 確認程式正常重啟

### 調試 updater.bat
- 打開批次腳本查看詳細步驟
- 檢查 %TEMP% 目錄下的臨時檔案
- 注意備份目錄是否正確創建
- 確認 PowerShell Expand-Archive 成功執行

### 常見問題

**Q: 更新後程式無法啟動?**
A: 檢查 _internal/ 目錄是否完整，Python DLL 是否正確

**Q: 更新後用戶數據丟失?**
A: 檢查 updater.bat 中的備份/還原邏輯

**Q: 更新卡住不動?**
A: 檢查是否有防毒軟體攔截，或檔案權限問題

**Q: 版本號顯示錯誤?**
A: 確認 version{版本號}.txt 檔案格式正確

## 未來改進方向

### 更新系統
- [ ] 增量更新 (只下載變更的檔案)
- [ ] 更新失敗自動回滾
- [ ] 更詳細的更新進度顯示
- [ ] 支援測試版/穩定版通道

### 打包系統
- [ ] 自動化版本號管理
- [ ] CI/CD 自動打包
- [ ] 數字簽章支援
- [ ] 自動生成更新日誌

## 技術棧

- **Python**: 3.13
- **GUI**: ttkbootstrap (tkinter)
- **打包**: PyInstaller
- **更新**: GitHub Releases API
- **更新器**: Windows Batch Script + PowerShell
