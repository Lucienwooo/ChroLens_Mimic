# 後台執行功能說明

## 🎯 新功能概述

現在 ChroLens_Mimic 支援**後台執行模式**！
您可以在程式回放腳本的同時，繼續操作其他視窗（例如：玩遊戲、瀏覽網頁）。

---

## 🔧 使用方法

### 1. 選擇目標視窗
- 點擊「選擇目標視窗」按鈕
- 從列表中選擇要自動化的視窗
- 綠色邊框閃現 2 秒確認選擇

### 2. 選擇後台模式
在腳本選單區的「後台模式」下拉選單中選擇：

#### 🌟 **smart（智能模式）** - 推薦
- 自動選擇最佳執行方法
- 優先嘗試 PostMessage（純後台）
- 失敗時自動切換到快速切換模式
- **適合大多數情況**

#### ⚡ **fast_switch（快速切換）** - 高相容性
- 快速切換到目標視窗執行操作
- 僅需 10ms 切換時間
- 幾乎支援所有程式
- **會短暫看到視窗切換**

#### 🔇 **postmessage（純後台）** - 完全不干擾
- 不移動真實滑鼠
- 完全在背景執行
- **部分程式可能不支援**（遊戲、DirectX 程式）

#### 🖱️ **foreground（前景模式）** - 傳統方式
- 移動真實滑鼠和鍵盤
- 會干擾您的操作
- 相容性最高

### 3. 錄製與回放
- 正常錄製腳本（F10）
- 開始回放（F12）
- 程式會根據選定的模式執行

---

## 📊 模式比較表

| 模式 | 移動真實滑鼠 | 相容性 | 干擾程度 | 推薦用途 |
|------|-------------|--------|----------|----------|
| **smart** | 依情況 | ⭐⭐⭐⭐ | 低~中 | 大多數情況 |
| **fast_switch** | ✅ | ⭐⭐⭐⭐⭐ | 低 | 需要高相容性 |
| **postmessage** | ❌ | ⭐⭐⭐ | 無 | 支援的程式 |
| **foreground** | ✅ | ⭐⭐⭐⭐⭐ | 高 | 傳統用法 |

---

## ✅ 支援程度

### 完全支援（所有模式）
- ✅ 一般視窗程式（記事本、檔案總管、小畫家）
- ✅ Office 軟體（Word、Excel、PowerPoint）
- ✅ 網頁瀏覽器（Chrome、Edge、Firefox）- 部分功能
- ✅ 開發工具（VS Code、命令提示字元）

### 部分支援（smart / fast_switch）
- ⚠️ 遊戲（取決於反作弊程度）
- ⚠️ DirectX/OpenGL 程式
- ⚠️ UWP 應用程式

### 不支援（需使用 foreground）
- ❌ 具有強反作弊保護的遊戲
- ❌ 需要硬體級別輸入的程式
- ❌ 全螢幕獨佔模式

---

## 🧪 測試案例

### 案例 1：自動化 Excel 同時瀏覽網頁

**步驟**：
1. 開啟 Excel
2. 選擇目標視窗 → Excel
3. 後台模式 → **smart** 或 **postmessage**
4. 錄製一些操作（輸入資料、點擊儲存）
5. 開啟瀏覽器開始瀏覽網頁
6. 按 F12 回放

**預期結果**：
- ✅ Excel 在背景自動執行操作
- ✅ 您可以正常瀏覽網頁
- ✅ 滑鼠不會亂跑

---

### 案例 2：遊戲掛機同時看影片

**步驟**：
1. 開啟遊戲（視窗模式）
2. 選擇目標視窗 → 遊戲視窗
3. 後台模式 → **fast_switch**
4. 錄製重複性操作
5. 開啟影片播放器
6. 按 F12 回放

**預期結果**：
- ⚠️ 會看到視窗快速切換（每次約 10-20ms）
- ✅ 大部分遊戲能正常執行
- ⚠️ 可能被部分遊戲偵測到

---

## 🔍 技術原理

### PostMessage 模式
```python
# 直接發送視窗訊息，不移動真實滑鼠
win32api.PostMessage(hwnd, WM_LBUTTONDOWN, MK_LBUTTON, lParam)
```

### Fast Switch 模式
```python
# 快速切換視窗
current = win32gui.GetForegroundWindow()
win32gui.SetForegroundWindow(target_hwnd)
time.sleep(0.01)  # 10ms
execute_action()
win32gui.SetForegroundWindow(current)
```

### 座標轉換
```python
# 螢幕座標 → 視窗內座標
def screen_to_client(hwnd, x, y):
    left, top, _, _ = win32gui.GetWindowRect(hwnd)
    return x - left, y - top
```

---

## ⚙️ 設定儲存

後台模式設定會自動儲存到 `user_config.json`：
```json
{
    "background_mode": "smart",
    "target_window": null,
    ...
}
```

---

## 💡 使用建議

1. **第一次使用**：選擇 **smart** 模式，讓程式自動判斷
2. **相容性問題**：改用 **fast_switch** 模式
3. **需要完全不干擾**：嘗試 **postmessage** 模式
4. **任何模式都失敗**：使用 **foreground** 模式

---

## 🐛 已知限制

1. **PostMessage 限制**
   - 某些程式會忽略 PostMessage
   - DirectX 遊戲通常不支援
   - 需要視窗處於可見狀態

2. **Fast Switch 限制**
   - 會短暫看到視窗切換
   - 可能干擾全螢幕程式
   - 某些遊戲可能視為異常行為

3. **通用限制**
   - 無法跨螢幕執行（如果目標視窗在另一個螢幕）
   - 目標視窗最小化時可能無效
   - 某些 UAC 提升權限的程式需要以管理員執行

---

## ❓ 常見問題

**Q: 為什麼 PostMessage 模式沒有反應？**
A: 該程式可能不支援 PostMessage，請改用 fast_switch 或 foreground 模式。

**Q: Fast Switch 模式會被遊戲偵測嗎？**
A: 可能會，取決於遊戲的反作弊系統。建議先在非重要帳號測試。

**Q: 可以完全隱藏程式視窗嗎？**
A: 可以，但目標視窗必須保持可見（不能最小化）。

**Q: 支援多個視窗同時自動化嗎？**
A: 目前不支援，一次只能針對一個目標視窗。

---

## 🚀 未來計畫

- [ ] 驅動層級輸入（繞過大部分偵測）
- [ ] 多視窗同時自動化
- [ ] 虛擬桌面支援
- [ ] 圖像辨識輔助
- [ ] 更智能的相容性偵測

---

## 📝 更新日誌

### v2.7 (2025-10-31)
- ✅ 新增後台執行模式
- ✅ 支援 4 種執行模式
- ✅ 自動座標轉換
- ✅ 智能模式選擇
- ✅ UI 整合後台模式選項

---

**祝您使用愉快！** 🎉
