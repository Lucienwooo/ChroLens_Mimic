# ChroLens_Mimic 更新摘要

## 版本資訊
- **更新日期**: 2025年11月24日
- **基礎版本**: 2.6.5
- **更新內容**: 時間限制優先順序修復 + 腳本合併功能

---

## 🔧 修復內容

### 1. 重複時間優先順序修復

**問題描述：**
- 當設定「重複次數=0, 重複時間=02:00:00」時，應該在2小時內無限重複
- 但實際會一直無限重複下去，不會在2小時後停止

**修復方案：**
- 修改 `recorder.py` 的 `_play_loop()` 方法，實作三種執行模式
- 優先順序：**重複時間 > 重複次數**

**執行模式：**

1. **時間限制模式（最高優先）**
   - 條件：`repeat_time_limit > 0`
   - 行為：在設定時間內無限重複執行
   - 檢查：每次循環和間隔等待時都檢查是否超時
   - 日誌：顯示「[時間限制模式] 將在 X.X 秒內重複執行」

2. **無限重複模式**
   - 條件：`repeat == -1` 且無時間限制
   - 行為：持續執行直到手動停止
   - 日誌：顯示「[無限重複模式] 將持續執行直到手動停止」

3. **次數限制模式**
   - 條件：`repeat > 0` 且無時間限制
   - 行為：執行指定次數後停止
   - 日誌：顯示「[次數限制模式] 將執行 X 次」

**修改檔案：**
- `ChroLens_Mimic.py` - `play_record()` 方法
- `recorder.py` - `play()` 和 `_play_loop()` 方法

---

## ✨ 新功能：腳本合併

### 功能說明
允許將多個腳本按順序合併為一個新腳本，實現：
- 腳本A執行完畢 → 立即執行腳本B → 繼續腳本C...
- 類似安卓模擬器的「腳本操作錄製」功能

### 使用方式

1. **開啟合併對話框**
   - 點擊主介面的「合併腳本」按鈕

2. **選擇腳本**
   - 左側列表：顯示所有可用腳本
   - 右側列表：待合併的腳本（按執行順序）
   - 點擊「➡ 加入」將腳本加入合併列表
   - 點擊「⬅ 移除」從合併列表移除

3. **調整順序**
   - 使用「⬆ 上移」和「⬇ 下移」調整執行順序
   - 順序決定腳本執行的先後

4. **設定參數**
   - **新腳本名稱**：輸入合併後的腳本名稱
   - **腳本間延遲**：每個腳本執行完畢後的等待時間（秒）

5. **執行合併**
   - 點擊「合併並儲存」
   - 系統自動調整時間戳，確保腳本無縫銜接
   - 合併完成後可選擇立即載入新腳本

### 技術細節

**時間戳調整邏輯：**
```python
時間偏移 = 0
對於每個腳本:
    1. 載入腳本事件
    2. 計算腳本基準時間（第一個事件的時間）
    3. 調整所有事件時間：新時間 = (原時間 - 基準時間) + 時間偏移
    4. 更新時間偏移：偏移 += 腳本持續時間 + 間隔時間
```

**範例：**
- 腳本A：0秒～10秒（10秒長）
- 間隔：2秒
- 腳本B：原始0秒～5秒（5秒長）
- **結果**：
  - A的事件：0～10秒（不變）
  - B的事件：12～17秒（10 + 2 + 原始時間）

**設定處理：**
- 合併後的腳本使用第一個腳本的設定（速度、重複次數等）
- 視窗資訊保留第一個腳本的設定

### UI 元件

**新增按鈕：**
- 位置：腳本選單區，「重新命名」按鈕後
- 樣式：綠色按鈕（SUCCESS）
- 文字：支援多語言（繁中、日文、英文）

**對話框佈局：**
```
┌─────────────────────────────────────────┐
│  📋 選擇要合併的腳本，按順序執行         │
├────────────┬────────┬──────────────────┤
│ 所有腳本   │ 控制   │ 待合併腳本        │
│            │ ➡ 加入 │ (執行順序)        │
│ □ 腳本1    │ ⬅ 移除 │ □ 腳本A          │
│ □ 腳本2    │        │ □ 腳本B          │
│ □ 腳本3    │ ⬆ 上移 │                  │
│            │ ⬇ 下移 │                  │
├────────────┴────────┴──────────────────┤
│ 新腳本名稱: [merged_script         ]   │
│ 腳本間延遲: [0    ] 秒                 │
│ [合併並儲存]  [取消]                    │
└─────────────────────────────────────────┘
```

---

## 📝 修改檔案列表

### 1. ChroLens_Mimic.py
- `play_record()`: 添加 `repeat_time_limit` 和 `repeat_interval` 參數
- `merge_scripts()`: 新增腳本合併功能（完整對話框和邏輯）
- `update_language()`: 添加合併按鈕的語言更新
- UI: 添加「合併腳本」按鈕及佈局調整

### 2. recorder.py
- `play()`: 添加時間限制和間隔參數
- `_play_loop()`: 完全重寫，實作三種執行模式
  - 時間限制檢查邏輯
  - 間隔等待時同步檢查時間限制
  - 詳細日誌輸出

### 3. lang.py
- 添加「合併腳本」翻譯：
  - 繁體中文：「合併腳本」
  - 日本語：「スクリプト結合」
  - English：「Merge Scripts」

---

## 🧪 測試建議

### 測試場景 1：時間限制優先
1. 錄製一個5秒的簡單腳本
2. 設定：重複次數=0，重複時間=00:00:30
3. 執行回放
4. **驗證**：應在30秒後自動停止，日誌顯示「[時間限制] 已達到設定時間」

### 測試場景 2：腳本合併
1. 創建兩個測試腳本（A和B）
2. 點擊「合併腳本」
3. 將A和B加入合併列表
4. 設定新名稱和間隔時間
5. 執行合併
6. **驗證**：
   - 新腳本成功創建
   - 載入並執行，觀察是否按A→B順序執行
   - 檢查時間戳是否正確調整

### 測試場景 3：時間+次數混合
1. 設定：重複次數=100，重複時間=00:01:00
2. **驗證**：即使設定100次，也應在1分鐘後停止（時間優先）

---

## ⚠️ 注意事項

1. **時間精度**：時間限制檢查間隔為0.1秒，可能有±0.1秒誤差
2. **腳本設定**：合併後使用第一個腳本的設定（速度、重複等）
3. **視窗相容性**：如各腳本使用不同視窗錄製，合併後可能需調整
4. **間隔計時**：腳本間延遲在時間限制模式下也計入總時間
5. **向下相容**：未使用時間限制功能的舊腳本不受影響

---

## 🎯 達成目標

✅ **問題1已修復**：重複時間現在正確優先於重複次數  
✅ **問題2已實作**：腳本合併功能完整實作，支援無縫銜接執行  
✅ **相容性**：參考安卓模擬器設計，使用體驗更直觀  
✅ **多語言**：所有新功能都支援繁中/日文/英文  
✅ **無語法錯誤**：所有修改檔案通過語法檢查

---

## 📚 相關檔案

- `test_time_limit.md` - 詳細測試說明和使用範例
- 主程式：`ChroLens_Mimic.py` (3840+ 行)
- 錄製核心：`recorder.py` (1200+ 行)
- 語言檔案：`lang.py` (272 行)

